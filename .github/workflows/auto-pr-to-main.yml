name: Auto PR para Main ap√≥s Deploy Dev

on:
  deployment_status:

jobs:
  create-pr:
    # Executa apenas quando deploy em dev for bem-sucedido
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Preview ‚Äì dev'
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
      
      - name: Verificar se PR j√° existe
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Busca PR aberto de dev para main
          PR_EXISTS=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number')
          
          if [ -n "$PR_EXISTS" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Criar Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Obt√©m √∫ltimo commit da branch dev
          LAST_COMMIT=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          
          # Cria corpo do PR com informa√ß√µes √∫teis
          PR_BODY=$(cat <<EOF
          ## üöÄ Deploy em Dev bem-sucedido!
          
          Este PR foi criado automaticamente ap√≥s o deploy bem-sucedido da branch \`dev\`.
          
          ### üìã Informa√ß√µes do Deploy
          - **√öltimo commit**: ${LAST_COMMIT}
          - **Autor**: ${COMMIT_AUTHOR}
          - **Deploy URL**: ${{ github.event.deployment_status.target_url }}
          - **Ambiente**: ${{ github.event.deployment.environment }}
          
          ### ‚úÖ Checklist de Review
          - [ ] Build passou sem erros
          - [ ] Deploy preview testado e validado
          - [ ] Core Web Vitals dentro do esperado
          - [ ] Formul√°rio de leads funcionando
          - [ ] Analytics configurado corretamente
          - [ ] Sem regress√µes visuais
          
          ### üìä Pr√≥ximos Passos
          1. Revisar mudan√ßas abaixo
          2. Testar deploy preview
          3. Aprovar e fazer merge para main
          4. Acompanhar deploy em produ√ß√£o
          
          ---
          
          **Deploy automatizado pela Vercel** ‚ú®
          EOF
          )
          
          # Cria o PR
          gh pr create \
            --base main \
            --head dev \
            --title "üöÄ Deploy: Merge dev ‚Üí main" \
            --body "$PR_BODY" \
            --label "auto-deploy,ready-for-review"
      
      - name: Comentar em PR existente
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ steps.check-pr.outputs.pr_number }} --body "‚úÖ **Novo deploy bem-sucedido em dev!**
          
          - **Deploy URL**: ${{ github.event.deployment_status.target_url }}
          - **Status**: Success
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          PR pronto para review e merge! üéâ"
      
      - name: Notificar Slack (opcional)
        if: steps.check-pr.outputs.exists == 'false'
        # Descomente e configure se quiser notifica√ß√µes no Slack
        # env:
        #   SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "‚úÖ PR criado com sucesso!"
          echo "Descomente a se√ß√£o acima para ativar notifica√ß√µes Slack"
